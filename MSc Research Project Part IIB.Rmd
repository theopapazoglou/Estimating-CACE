---
title: "MSc Research Project Part IIB"
author: "Theodosios Papazoglou"
date: "2024-07-16"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries}
library(dplyr)
library(descr)
library(estimatr)
library(Metrics)
```

This paper follows the work presented in MSc Research Project Part I. In Part I we presented the theoretical framework for the Per-Protocol and IV analyses for estimating the Complier Average Causal Effect (CACE). We also presented the work from simulations regarding the All-or-None compliance case. In this paper, we will present the set-up, code and results from the partial compliance case. We will begin with the case where both always takers and never takers are allowed, i.e. participants from both treatment groups have access to the opposite treatment (CPAP and control). Afterwards, we will examine the case where only never takers are allowed, i.e. CPAP is only available to patients in the treatment group. Let us present our set-up in this case which will be slightly different from the previous one used in the All-or-None case.
\par The CPAP treatment is a treatment administered during sleep. The average sleep time for pregnant women is 7-9 hours. We will assume that a complete use of CPAP is 8 hours per day, i.e. is used for the whole duration of sleep. For participants who use CPAP for 8 hours we define $D=1$. We will consider the following partial cases, 
\begin{enumerate}
 \item Participants who use CPAP for 0 hours, i.e. they do not use treatment at all ($D=0$),
 \item Participants who use CPAP for 2 hours ($D=1/4$),
 \item Participants who use CPAP for 4 hours ($D=1/2$) and
 \item Participants who use CPAP for 6 hours ($D=3/4$)
\end{enumerate}
The data generating process (DGM) is similar to that in the All-or-None case. First, we generate the potential outcomes as before, $Y(0)\sim N(74,1)$, $Y(1)\sim N(69,1)$ and then randomly assign participants to either treatment or control, $Z\sim\text{Bernoulli}(0.5)$. For each treatment group, we will assign different proportions of participants to one of the 5 cases mentioned above ($D=1$, $D=3/4$, $D=1/2$, $D=1/4$ and $D=0$). In this specific simulation we will define the following proportions: \par
For the control group,
$50\%$ comply with the control treatment ($D=0$), $20\%$ take CPAP for 2 hours ($D=1/4$), $10\%$ take CPAP for 4 hours ($D=1/2$), $10\%$ take CPAP for 6 hours ($D=3/4$) and $10\%$ take CPAP for 8 hours ($D=1$). 
\par
For the treatment group,
$50\%$ comply with the allocated treatment ($D=1$), $20\%$ take CPAP for 6 hours ($D=3/4$), $10\%$ take CPAP for 4 hours ($D=1/2$), $10\%$ take CPAP for 2 hours ($D=1/4$) and $10\%$ do not take CPAP at all ($D=0$). \par  We will consider different proportions after completing the whole simulation run. After assigning these values for every participant, we define the observed outcomes as before, $Y=DY(1)+(1-D)Y(0)$. We will consider different thresholds of true compliance for the treatment group, i.e. number of hours of CPAP use, and we will test the two methods (Per-Protocol and IV). For example, one threshold that we will use is to consider as true compliers, participants who took at least $75\%$ of the CPAP treatment. In particular, for our simulations we will consider the following 4 cases for the compliance threshold, 
\begin{enumerate}
 \item CASE I: True compliers are defined as participants who take the whole CPAP treatment (8 hours),
 \item CASE II: True compliers are defined as participants who take at least $75\%$ of the CPAP treatment (at least 6 hours),
 \item CASE III: True compliers are defined as participants who take at least half ($50\%$) of the CPAP treatment (at least 4 hours), and
 \item CASE IV: True compliers are defined as participants who take any part of the CPAP treatment (more than 0 hours)
\end{enumerate}

Some comments based on the set-up: When considering different thresholds of compliance in Cases I-IV, we do not expect the values of the IV estimates to differ since they remain unaffected by the threshold selection; they only depend on the values of D. However, the true treatment effect in compliers and the Per-Protocol estimates are expected to change in each case. So, we are interested to see if using a specific threshold will yield estimates closer to the truth. 

The case described above corresponds to the case of random non-compliance, where we specify random proportions of participants who do not take the treatment. We will present results collectively for every implementation at the end of Case IV.
We begin with Case I. 
\par
The structure of the code is similar to that presented in Part I with the necessary adjustments. First, we generate the potential outcomes and randomly assign patients to treatment or control. We then assign the patients to the values of $D$ based on the proportions specified above and generate the observed outcome. In this case, the true compliers in the treatment group are defined as participants who took the whole CPAP treatment ($D=1$ if $Z=1$). We calculate the true treatment effect in compliers as $\mathbb{E}[Y(1)-Y(0)|C=1]$ where $C=1$ consists of compliers in the two treatment groups, i.e. for the treatment group ($Z=1$) compliers are defined as participants with $D=1$ and for the control group ($Z=0$) compliers are defined as participants with $D=0$. We then calculate the Per-Protocol and IV estimates as before. The Per-Protocol population consists from participants who complied based on each specific threshold. For example, when considering participants in the treatment group who received at least $75\%$ of the CPAP treatment as compliers, these participants will be in the Per-Protocol population in the treatment group as well. 
```{r randompartial1}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Next, we consider Case II. Here, true compliers in the treatment group are defined as participants who took at least $75\%$ of the CPAP treatment, i.e. participants with $D=1$ and $D=3/4$. 
```{r randompartial2}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```


Next, we consider Case III. Here, true compliers in the treatment group are defined as participants who took at least $50\%$ of the CPAP treatment, i.e. participants with $D=1$, $D=3/4$ and $D=1/2$. 
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Finally, we consider Case IV. Here, true compliers in the treatment group are defined as participants who took any part of the CPAP treatment, i.e. participants with $D\neq0$. 
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: We observe that for every case (I-IV), the IV analysis yields unbiased estimates for CACE when compliance is partial, non-compliance is random (at least when considering the specific proportions used above) and non-compliance can occur in both treatment groups (both always-takers and never-takers). The Per-Protocol analysis yields an unbiased estimate only in case I, where compliers are considered as the participants who took the whole CPAP treatment. We also observe that when non-compliance is random, the ATE coincides with the CACE and thus the treatment effect in compliers doesn't change when considering different thresholds.


We will now proceed to investigate the results of the two methods when non-compliance is not random and we will use the same non-random scenarios as in the All-or-None case. Let us remember the 6 scenarios,
\begin{enumerate}
 \item \textbf{Scenario A}: Participants with good conditions (low DBP) would never receive the treatment, i.e. $D=0$ if $Y(0)<\mu_0 - \delta,$
 \item \textbf{Scenario B}: Participants with bad conditions (high DBP) would never receive the treatment, i.e. $D=0$ if $Y(0) > \mu_0 + \delta,$
 \item \textbf{Scenario C}: Participants with good conditions (low DBP) would always receive the treatment, i.e. $D=1$ if $Y(0)<\mu_0 - \delta,$
 \item \textbf{Scenario D}: Participants with bad conditions (high DBP) would always receive the treatment, i.e. $D=1$ if $Y(0)>\mu_0 + \delta,$
 \item \textbf{Scenario E}: Participants with bad conditions would always receive the treatment, i.e. $D=1$ if $Y(0)>\mu_0 + \delta$, and participants with good conditions would always reject the treatment, i.e. $D=0$ if $Y(0)<\mu_0 - \delta,$
 \item \textbf{Scenario F}: Participants with bad conditions would never receive the treatment, i.e. $D=0$ if $Y(0)>\mu_0 + \delta$, and participants with good conditions would always receive the treatment, i.e. $D=1$ if $Y(0)<\mu_0 - \delta$.
\end{enumerate}

We will test all Scenarios for $\delta=0.5$ and $\delta=1$, i.e. severe or mild dependence on $Y(0)$ respectively.

We begin with Scenario A. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario A which is highlighted inside the code. Below is the implementation for Scenario A, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
We proceed with Scenario A, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario A, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario A, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
We proceed with Scenario A, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario A, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario A, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: For Scenario A, where participants with good conditions (low DBP) would never receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for either value of $\delta$. Here we observe that the IV estimates do not change when considering different thresholds since they are unaffected by the choice of threshold. However, we see that the true treatment effect in compliers and the Per-Protocol estimates change with each threshold value. In particular, the Per-Protocol estimate becomes more biased as we include more partial compliers in the Per-Protocol population.

We proceed with Scenario B. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario B which is highlighted inside the code. Below is the implementation for Scenario B, Case I. We first set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next we implement Scenario B, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
We proceed with Scenario B, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario B, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next we implement Scenario B, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
We proceed with Scenario B, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario B, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: For Scenario B, where participants with bad conditions (high DBP) would never receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for either value of $\delta$. Only in Case II, the Per-Protocol estimate is approximately unbiased (Bias = 0.02) for the CACE but not for the ATE for $\delta=0.5$.

We proceed with Scenario C. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario C which is highlighted inside the code. Below is the implementation for Scenario C, Case I. First, we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Next, we implement Scenario C, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

We now implement Scenario C, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Finally, we implement Scenario C, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Next, we implement Scenario C, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

We now implement Scenario C, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Finally, we implement Scenario C, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: For Scenario C, where participants with good conditions (low DBP) would always receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for either value of $\delta$. Only in Case III, the Per-Protocol estimate is approximately unbiased for the CACE (Bias = -0.01) but not for the ATE for $\delta=0.5$. Also, for $\delta=1$ in Case II, the Per-Protocol estimator is unbiased for the ATE and approximately unbiased for the CACE (Bias=-0.04).

We proceed with Scenario D. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario D which is highlighted inside the code. Below is the implementation for Scenario D, Case I. First, we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario D, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario D, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario D, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario D, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario D, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario D, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For Scenario D, where participants with bad conditions (high DBP) would always receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for either value of $\delta$.

We proceed with Scenario E. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario E which is highlighted inside the code. Below is the implementation for Scenario E, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario E, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario E, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario E, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario E, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario E, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario E, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For Scenario E, where participants with bad conditions would always receive the treatment and participants with good conditions would always reject the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for $\delta=0.5$. The Per-Protocol analysis also yields biased estimates for both the ATE and CACE for $\delta=1$. However, the IV analysis yields approximately unbiased estimates for the CACE when considering $\delta=1$ (Bias=0.04).

We proceed with Scenario F. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario F which is highlighted inside the code. Below is the implementation for Scenario F, Case I. First, we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next we implement Scenario F, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario F, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario F, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next we implement Scenario F, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario F, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario F, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: For Scenario F, where participants with bad conditions would never receive the treatment and participants with good conditions would always receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), the Per-Protocol analysis yields biased estimates for both the ATE and the CACE, for either value of $\delta$. Only for $\delta=1$ in Case III, the Per-Protocol analysis yields an unbiased estimate for the CACE. On the other hand, the IV analysis yields approximately unbiased estimates for the CACE for all cases when $\delta=0.5$ (Bias=-0.03) and unbiased estimates when $\delta=1$!


Now we will proceed to implement the random and non-random partial compliance when we only allow non-compliers in the treatment group, i.e. we allow only never-takers. The difference here is, that for every participant in the control group we define $D=0$, while for the participants in the treatment group we will consider the same proportions as above. We begin with the implementation of the 4 cases to the random non-compliance case. Below is the code for Case I.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For the partial compliance case where we only allow non-compliers in the treatment group (only never-takers) and the non-compliance is random, the IV analysis yield unbiased estimates for both the ATE and the CACE. The Per-Protocol analysis yields an unbiased estimate only in case I for both the CACE and the ATE. For the remaining three, the estimates are biased for both the CACE and the ATE. Furthermore, we make the same observations as in the random case where both never-takers and always-takers were allowed. The ATE coincides with the CACE and the treatment effect in compliers doesn't change when considering different thresholds for compliance.

We now proceed to the non-random non-compliance cases. The only plausible of the 6 Scenarios, when we allow only for never-takers, are Scenarios A and B. We will implement all 4 cases for these two Scenarios and this will conclude our experimentation. We begin with Scenario A, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario A, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Scenario A, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenaerio A, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario A, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Scenario A, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenaerio A, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For Scenario A, where participants with good conditions (low DBP) would never receive the treatment, for both cases (I-IV), where we allow non-compliers only in the treatment group (only never-takers), both the Per-Protocol and the IV analyses yield biased estimates for the CACE, while the IV also yields biased estimates for the ATE as well, regardless of the value of $\delta$. However, the Per-Protocol analysis yields an unbiased estimate in Case I for the ATE for both values of $\delta$.

We proceed with Scenario B. We will implement it for all 4 cases (Cases I-IV). Below is the implementation for Scenario B, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario B, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Scenario B, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario B, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario B, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Scenario B, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario B, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: For Scenario B, where participants with bad conditions (high DBP) would never receive the treatment, for both cases (I-IV), where we allow non-compliers only in the treatment group (only never-takers), both the Per-Protocol and the IV analyses yield biased estimates for CACE, while the IV also yields biased estimates for the ATE as well, regardless the value of $\delta$. However, the Per-Protocol analysis yields an unbiased estimates in Case I for the ATE for both values of $\delta$.


In summary, for partial compliance, when non-compliance occurs at random, the IV analysis will yield unbiased estimates, regardless of the compliance threshold or the type of non-compliers. The Per-Protocol analysis will yield unbiased estimates only in Case I and biased for Cases II-IV for both the ATE and CACE. On the other hand, when non-compliance does not occur at random, none of the two methods yields an unbiased estimate for any of the six scenarios considered regardless of the compliance threshold or the type of non-compliers. Only for Scenario F, when we allow for both always-takers and never-takers, the IV analysis yields an estimate that is almost unbiased for all 4 cases. Also, when considering non-compliers only in the treatment group, i.e. only never-takers, the Per-Protocol analysis will yield an unbiased estimate for the ATE in Case I.



We will now re-run all the simulations above but this time we will set the true treatment effect equal to $0$, i.e. $\mu_0=\mu_1=74$. We begin with random non-compliance and Case I.
```{r randompartial1b}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Next, we consider Case II. Here, true compliers in the treatment group are defined as participants who took at least $75\%$ of the CPAP treatment, i.e. participants with $D=1$ and $D=3/4$. 
```{r randompartial2b}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```


Next, we consider Case III. Here, true compliers in the treatment group are defined as participants who took at least $50\%$ of the CPAP treatment, i.e. participants with $D=1$, $D=3/4$ and $D=1/2$. 
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Finally, we consider Case IV. Here, true compliers in the treatment group are defined as participants who took any part of the CPAP treatment, i.e. participants with $D\neq0$. 
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: We observe that for every case (I-IV), both the Per-Protocol and the IV analyses yield unbiased estimates for CACE when compliance is partial, non-compliance is random (at least when considering the specific proportions used above) and non-compliance can occur in both treatment groups (both always-takers and never-takers). We also observe that when non-compliance is random, the ATE coincides with the CACE and thus the treatment effect in compliers doesn't change when considering different thresholds (it is always equal to $0$).


We will now proceed to investigate the results of the two methods when non-compliance is not random and we will use the same non-random scenarios as in the All-or-None case. Let us remember the 6 scenarios,
\begin{enumerate}
 \item \textbf{Scenario A}: Participants with good conditions (low DBP) would never receive the treatment, i.e. $D=0$ if $Y(0)<\mu_0 - \delta,$
 \item \textbf{Scenario B}: Participants with bad conditions (high DBP) would never receive the treatment, i.e. $D=0$ if $Y(0) > \mu_0 + \delta,$
 \item \textbf{Scenario C}: Participants with good conditions (low DBP) would always receive the treatment, i.e. $D=1$ if $Y(0)<\mu_0 - \delta,$
 \item \textbf{Scenario D}: Participants with bad conditions (high DBP) would always receive the treatment, i.e. $D=1$ if $Y(0)>\mu_0 + \delta,$
 \item \textbf{Scenario E}: Participants with bad conditions would always receive the treatment, i.e. $D=1$ if $Y(0)>\mu_0 + \delta$, and participants with good conditions would always reject the treatment, i.e. $D=0$ if $Y(0)<\mu_0 - \delta,$
 \item \textbf{Scenario F}: Participants with bad conditions would never receive the treatment, i.e. $D=0$ if $Y(0)>\mu_0 + \delta$, and participants with good conditions would always receive the treatment, i.e. $D=1$ if $Y(0)<\mu_0 - \delta$.
\end{enumerate}

We will test all Scenarios for $\delta=0.5$ and $\delta=1$, i.e. severe and mild dependence on $Y(0)$ (Bang & Davis 2007).

We begin with Scenario A. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario A which is highlighted inside the code. Below is the implementation for Scenario A, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
We proceed with Scenario A, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario A, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario A, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
We proceed with Scenario A, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario A, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario A, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For Scenario A, where participants with good conditions (low DBP) would never receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for either value of $\delta$. Here we observe that the IV estimates do not change when considering different thresholds since they are unaffected by the choice of threshold. However, we see that the true treatment effect in compliers and the Per-Protocol estimates change with each threshold value. 

We proceed with Scenario B. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario B which is highlighted inside the code. Below is the implementation for Scenario B, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next we implement Scenario B, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
We proceed with Scenario B, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario B, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next we implement Scenario B, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
We proceed with Scenario B, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario B, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For Scenario B, where participants with bad conditions (high DBP) would never receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for either value of $\delta$.

We proceed with Scenario C. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario C which is highlighted inside the code. Below is the implementation for Scenario C, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Next, we implement Scenario C, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

We now implement Scenario C, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Finally, we implement Scenario C, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Next, we implement Scenario C, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

We now implement Scenario C, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Finally, we implement Scenario C, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: For Scenario C, where participants with good conditions (low DBP) would always receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for either value of $\delta$.

We proceed with Scenario D. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario D which is highlighted inside the code. Below is the implementation for Scenario D, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario D, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario D, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario D, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario D, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario D, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario D, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For Scenario D, where participants with bad conditions (high DBP) would always receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for either value of $\delta$.

We proceed with Scenario E. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario E which is highlighted inside the code. Below is the implementation for Scenario E, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario E, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario E, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario E, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario E, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario E, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario E, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: For Scenario E, where participants with bad conditions would always receive the treatment and participants with good conditions would always reject the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), both the Per-Protocol and the IV analyses yield biased estimates for both the ATE and the CACE for $\delta=0.5$. Also, the Per-Protocol analysis yields biased estimates for $\delta=1$. However, the IV analysis yields approximately unbiased estimates for the CACE when considering $\delta=1$.

We proceed with Scenario F. We will implement it for all 4 cases (Cases I-IV). The code remains exactly the same with the addition of the condition for Scenario F which is highlighted inside the code. Below is the implementation for Scenario F, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next we implement Scenario F, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario F, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario F, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next we implement Scenario F, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now, we implement Scenario F, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario F, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Conclusive comments: For Scenario F, where participants with bad conditions would never receive the treatment and participants with good conditions would always receive the treatment, for both cases (I-IV), where we allow non-compliers in both treatment groups (both always-takers and never-takers), the Per-Protocol analysis yields biased estimates for both the ATE and the CACE, for both values of $\delta$. On the other hand, the IV analysis yields approximately unbiased estimates for the CACE when $\delta=0.5$ and unbiased estimates when $\delta=1$!


Now we will proceed to implement the random and non-random partial compliance when we only allow non-compliers in the treatment group, i.e. we allow only never-takers. The difference here is, that for every participant in the control group we define $D=0$, while for the participants in the treatment group we will consider the same proportions as above. We begin with the implementation of the 4 cases to the random non-compliance case. Below is the code for Case I.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For the partial compliance case where we only allow non-compliers in the treatment group (only never-takers) and the non-compliance is random, both the Per-Protocol and the IV analyses yield unbiased estimates for both the ATE and the CACE. Furthermore, we make the same observations as in the random case where both never-takers and always-takers were allowed. The ATE coincides with the CACE and the treatment effect in compliers doesn't change when considering different thresholds for compliance (it is always equal to $0$).

We now proceed to the non-random non-compliance cases. The only plausible of the 6 Scenarios, when we allow only for never-takers, are Scenarios A and B. We will implement all 4 cases for these two Scenarios and this will conclude our experimentation. We begin with Scenario A, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario A, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Scenario A, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenaerio A, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario A, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Scenario A, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenaerio A, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For Scenario A, where participants with good conditions (low DBP) would never receive the treatment, for both cases (I-IV), where we allow non-compliers only in the treatment group (only never-takers), both the Per-Protocol and the IV analyses yield biased estimates for CACE, while the IV also yields biased estimates for the ATE as well, regardless of the value of $\delta$. However, the Per-Protocol analysis yields an unbiased estimate in Case I for the ATE for both values of $\delta$.

We proceed with Scenario B. We will implement it for all 4 cases (Cases I-IV). Below is the implementation for Scenario B, Case I. First we set $\delta=0.5$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario B, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Scenario B, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario B, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Now we set $\delta=1$.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Next, we implement Scenario B, Case II.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Now we implement Scenario B, Case III.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Finally, we implement Scenario B, Case IV.
```{r}
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


set.seed(123)
nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```
Conclusive comments: For Scenario B, where participants with bad conditions (high DBP) would never receive the treatment, for both cases (I-IV), where we allow non-compliers only in the treatment group (only never-takers), both the Per-Protocol and the IV analyses yield biased estimates for CACE, while the IV also yields biased estimates for the ATE as well, regardless of the value of $\delta$. However, the Per-Protocol analysis yields an unbiased estimates in Case I for the ATE for both values of $\delta$.

In summary, the results we observe when setting the true treatment effect equal to $0$, do not differ from those observed when the treatment effect was set equal to $5$.