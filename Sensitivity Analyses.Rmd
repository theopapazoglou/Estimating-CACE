---
title: "Sensitivity Analyses"
author: "Theodosios Papazoglou"
date: "2024-08-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document contains the sensitivity simulation analyses employed during the MSc Research Project at the Department of Mathematics of Imperial College of London titled "Estimating the Complier Average Causal Effect in Randomised Controlled Trials with Non-Compliance: A Comparative Simulation Analysis of the Instrumental Variables and Per Protocol Methods" from MSc student Theodosios (Theo) Papazoglou. 


First we load the libraries used throughout the simulations.
```{r}
library(dplyr)
library(descr)
library(estimatr)
library(Metrics)
library(ggplot2)
library(reshape2)
```

We will begin with all the sensitivity analyses for the Binary Compliance and we'll then proceed to the Partial Compliance case.
Sensitivity analysis I: Consider mild ($\delta=1$) non-random non-compliance for the dependent scenarios. For this sensitivity analysis we use the random seed that was used in the main simulation analysis as well, i.e. 24.

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation1}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation2}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation3}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation4}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation5}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation6}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation7}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation8}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, ifelse(dt$Y0 > mean0 + 1, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Sensitivity analysis II: We consider the treatment effect (ATE) is equal to $0$. We will consider both severe and mild dependent scenarios. For this sensitivity analysis we set the random seed equal to 42.

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation9}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0) #Category 1 corresponds to Never-Takers and 2 to Compliers
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  obs_non_compl <- length(which(dt$D != dt$Z))/350
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #Instrumental Variable estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    est_never_taker_freq,
    obs_non_compl <- obs_non_compl,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 10, nrow = nsim))
x <- c("simulation","est_never_taker_freq","obs_non_compl","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation10}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation11}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation12}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation13}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation14}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0) #D = ZD(1) + (1-Z)D(0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0) 
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 13, nrow = nsim))
x <- c("simulation","obs_non_compl","obs_always_takers","obs_never_takers","est_never_taker_freq","est_always_taker_freq",
       "true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP effect:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV effect:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation15}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol  estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation16}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation17}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation18}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation19}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation20}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation21}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation22}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation23}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation24}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation25}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 2, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation26}
set.seed(42)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, ifelse(dt$Y0 > mean0 + 1, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Sensitivity analysis III: We will consider a different proportion of non-compliers. In the main analysis, we considered $40\%$ of the study participants to be non-compliers. Here, we will assume that $60\%$ of the study participants are non-compliers. In the presence of both never-takers and always-takers we will assume that $40\%$ are never-takers and $20\%$ are always-takers. For the dependent scenarios we will consider both the severe and mild cases. We will only consider this for a treatment effect equal to $5$. For this sensitivity analysis we set the random seed equal to 2424.

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation27}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.6, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0) #Category 1 corresponds to Never-Takers and 2 to Compliers
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  obs_non_compl <- length(which(dt$D != dt$Z))/350
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #Instrumental Variable estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    est_never_taker_freq,
    obs_non_compl <- obs_non_compl,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 10, nrow = nsim))
x <- c("simulation","est_never_taker_freq","obs_non_compl","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation28}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.6, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation29}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.6, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation30}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.6, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation31}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.6, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation32}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0) #D = ZD(1) + (1-Z)D(0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0) 
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}

nsim <- 500
estimates <- data.frame(matrix(ncol = 13, nrow = nsim))
x <- c("simulation","obs_non_compl","obs_always_takers","obs_never_takers","est_never_taker_freq","est_always_taker_freq",
       "true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP effect:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV effect:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation33}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation34}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation35}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation36}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation37}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol  estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation38}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation39}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation40}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation41}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation42}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation43}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 2, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation44}
set.seed(2424)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.4, p_alwaystakers = 0.2, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, ifelse(dt$Y0 > mean0 + 1, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```


We now move on to the sensitivity analyses for the partial compliance case.
Sensitivity analysis IV: Consider mild non-random non-compliance for the dependent scenarios. For this sensitivity analysis we consider the same seed as the main analysis, i.e. 24.

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation45}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation46}
set.seed(1924)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation47}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation48}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation49}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation50}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation51}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation52}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation53}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation54}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation55}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation56}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Sensitivity analysis V: Consider different compliance thresholds. Specifically, for the 4 cases of Compliance Threshold (applied only for the Partial Compliance case) we use the following,
\begin{enumerate}
 \item CASE I: True compliers are defined as participants who take the whole CPAP treatment (8 hours),
 \item CASE II: True compliers are defined as participants who take at least $75\%$ of the CPAP treatment (at least 6 hours),
 \item CASE III: True compliers are defined as participants who take at least half ($50\%$) of the CPAP treatment (at least 4 hours), and
 \item CASE IV: True compliers are defined as participants who take any part of the CPAP treatment (more than 0 hours)
\end{enumerate}

Case I was used throughout the main simulation analysis. Now we consider the remaining three. We apply them for both severe and mild non-random non-compliance. For this sensitivity analysis we consider the same seed as in the main analysis, i.e. 24.

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation57}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation58}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation59}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation60}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation61}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation62}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation63}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation64}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation65}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation66}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation67}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation68}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation69}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation70}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation71}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation72}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation73}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation74}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation75}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation76}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation77}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation78}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation79}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation80}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation81}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation82}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation83}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation84}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation85}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation86}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulations87}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation88}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation89}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation90}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation91}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation92}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation93}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation94}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation95}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation96}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation97}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation98}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation99}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation100}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation101}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation102}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation103}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation104}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation105}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation106}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation107}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation108}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation109}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation110}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation111}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation112}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation113}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation114}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation115}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation116}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation117}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation118}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation119}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation120}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation121}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation122}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation123}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation124}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation125}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation126}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation127}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation128}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation129}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation130}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation131}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation132}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation133}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation134}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Sensitivity Analysis VI: We now set the treatment effect (ATE) equal to $0$. We run the analysis for both severe and mild cases of non-randomness and for all 4 cases of compliance threshold. We use the same seed used for the binary compliance case when the ATE was equal to $0$, i.e. 42.

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation135}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation136}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation137}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation138}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation139}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation140}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation141}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation142}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation143}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation144}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation145}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation146}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation147}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation148}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation149}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation150}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation151}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation152}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation153}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation154}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation155} 
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation156}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation157}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation158}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation159}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation160}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation161}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation162}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation163}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation164}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation165}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation166}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation167}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation168}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation169}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation170}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation171}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation172}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation173}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation174}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation175}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulations176}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation177}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation178}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation179}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation180}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation181}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation182}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation183}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation184}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation185}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation186}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation187}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario G
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation188}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation189}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation190}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation191}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation192}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation193}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation194}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation195}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation196}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation197}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation198}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation199}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation200}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation201}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation202}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation203}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation204}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation205}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation206}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation207}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation208}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation209}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation210}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation211}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation212}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation213}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation214}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation215}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation216}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation217}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation218}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation219}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation220}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation221}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation222}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation223}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation224}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation225}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation226}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation227}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation228}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation229}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation230}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation231}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation232}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation233}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation234}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation235}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation236}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation237}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$. 
```{r simulation238}
set.seed(42)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

Simulation analysis VII: Different random proportions.
For the control group, $60\%$ comply with the control treatment ($D=0$), $10\%$ take CPAP for 2 hours ($D=1/4$), $10\%$ take CPAP for 4 hours ($D=1/2$), $10\%$ take CPAP for 6 hours ($D=3/4$) and $10\%$ take CPAP for 8 hours ($D=1$). 
For the treatment group, $40\%$ comply with the allocated treatment ($D=1$), $10\%$ take CPAP for 6 hours ($D=3/4$), $10\%$ take CPAP for 4 hours ($D=1/2$), $10\%$ take CPAP for 2 hours ($D=1/4$) and $30\%$ do not take CPAP at all ($D=0$).
For this sensitivity analysis we use the same random seed used in the binary compliance case with the different proportions, i.e. 2424.

The following code chunk implements the Random Non-Compliance case for the new proportions in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation239}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}

nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case for the new proportions in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation240}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}

nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case for the new proportions in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation241}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}

nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case for the new proportions in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation242}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}

nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation243}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation244}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation245}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation246}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation247}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation248}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation249}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation250}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation251}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation252}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation253}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation254}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation255}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation256}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation257}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation258}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation259} 
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation260}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation261}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation262}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation263}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation264}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation265}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation266}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation267}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation268}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation269}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation270}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation271}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation272}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation273}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation274}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation275}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation276}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation277}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation278}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation279}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias, "\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulations280}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation281}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation282}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation283}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation284}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation285}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation286}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation287}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation288}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation289}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation290}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation291}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario G
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation292}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation293}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation294}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation295}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation296}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation297}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation298}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation299}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation300}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation301}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation302}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation303}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation304}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation305}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation306}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.6, 0.1, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation307}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation308}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation309}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation310}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation311}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation312}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation313}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation314}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation315}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation316}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation317}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation318}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation319}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation320}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation321}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation322}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation323}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation324}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation325}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation326}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation327}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation328}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation329}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation330}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation331}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation332}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation333}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation334}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation335}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation336}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation337}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation338}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation339}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation340}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation341}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$. 
```{r simulation342}
set.seed(2424)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.4, 0.1, 0.1, 0.1, 0.3)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```




