---
title: "Estimating the Complier Average Causal Effect in Randomised Controlled Trials with Non-Compliance: A Comparison of the Instrumental Variables and Per Protocol Analyses"
author: "Theodosios Papazoglou"
date: "2024-07-20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document contains the complete code used during the MSc Research Project at the Department of Mathematics of Imperial College of London titled "Estimating the Complier Average Causal Effect in Randomised Controlled Trials with Non-Compliance: A Comparison of the Instrumental Variables and Per Protocol Analyses" from MSc student Theodosios (Theo) Papazoglou. To replicate the following simulations you can use the code as provided setting the seed equal to 24.
\par
First we load the libraries used throughout the simulations.
```{r}
library(dplyr)
library(descr)
library(estimatr)
library(Metrics)
library(ggplot2)
library(reshape2)
```

\par
We consider two cases of Compliance, Binary and Partial for a total of 244 different simulation cases. For the Non-Random Scenarios we use the following,
\begin{enumerate}
 \item \textbf{Scenario A}: Participants with good conditions would never receive the treatment,
 \item \textbf{Scenario B}: Participants with bad conditions would never receive the treatment,
 \item \textbf{Scenario C}: Participants with good conditions would always receive the treatment, 
 \item \textbf{Scenario D}: Participants with bad conditions would always receive the treatment, 
 \item \textbf{Scenario E}: Participants with bad conditions would always receive the treatment and participants with good conditions would always reject the treatment,
 \item \textbf{Scenario F}: Participants with bad conditions would never receive the treatment and participants with good conditions would always receive the treatment,
 \item \textbf{Scenario G}: Participants with good conditions would never receive the treatment and participants with severe bad conditions would always receive the treatment. Additionally, participants with moderately bad conditions would always receive three quarters of the treatment, participants with moderate to mild bad conditions would receive half of the treatment and participants with mild bad conditions would always receive a quarter of the treatment.
 \item \textbf{Scenario H}: Participants with bad conditions would never receive the treatment and participants with severe good conditions would always receive the treatment. Additionally, participants with moderately good conditions would always receive three quarters of the treatment, participants with moderate to mild good conditions would receive half of the treatment and participants with mild good conditions would always receive a quarter of the treatment.
\end{enumerate}

For the Binary Compliance case only Scenarios A-F are applied and for the Partial Compliance case all 8 Scenarios are Applied, when allowing for both Always-Takers and Never-Takers. When allowing only for Never-Takers, Scenarios A and B are applied to the Binary Compliance case and Scenarios A,B,G and H are applied to the Partial Compliance case. 
\par
For the 4 cases of Compliance Threshold (applied only for the Partial Compliance case) we use the following,
\begin{enumerate}
 \item CASE I: True compliers are defined as participants who take the whole CPAP treatment (8 hours),
 \item CASE II: True compliers are defined as participants who take at least $75\%$ of the CPAP treatment (at least 6 hours),
 \item CASE III: True compliers are defined as participants who take at least half ($50\%$) of the CPAP treatment (at least 4 hours), and
 \item CASE IV: True compliers are defined as participants who take any part of the CPAP treatment (more than 0 hours)
\end{enumerate}
\par
For more details on the structure of the simulations see the final version of the Thesis.

For the Binary Compliance we vary the following factors,
\begin{enumerate}
 \item True Treatment Effect,
 \item Type of Non-Compliers,
 \item Randomness of Non-compliers (For the Non-Random case we consider severe and mild Non-Randomness)
\end{enumerate}


The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation1}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0) #Category 1 corresponds to Never-Takers and 2 to Compliers
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  obs_non_compl <- length(which(dt$D != dt$Z))/350
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #Instrumental Variable estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    est_never_taker_freq,
    obs_non_compl <- obs_non_compl,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 10, nrow = nsim))
x <- c("simulation","est_never_taker_freq","obs_non_compl","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_1 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_1 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_1, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_1,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```


The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation2}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_2 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_2 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_2, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_2,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation3}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_3 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_3 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_3, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_3,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation4}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_4 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_4 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_4, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_4,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation5}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_5 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_5 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_5, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_5,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation6}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0) #D = ZD(1) + (1-Z)D(0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0) 
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}

nsim <- 500
estimates <- data.frame(matrix(ncol = 13, nrow = nsim))
x <- c("simulation","obs_non_compl","obs_always_takers","obs_never_takers","est_never_taker_freq","est_always_taker_freq",
       "true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_6 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_6 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP effect:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_6, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV effect:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_6,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation7}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_7 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_7 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_7, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_7,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation8}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_8 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_8 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_8, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_8,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation9}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_9 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_9 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_9, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_9,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation10}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_10 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_10 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_10, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_10,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$. 
```{r simulation11}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol  estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_11 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_11 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_11, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_11,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation12}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_12 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_12 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_12, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_12,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation13}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_13 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_13 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_13, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_13,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation14}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_14 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_14 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_14, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_14,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation15}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_15 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_15 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_15, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_15,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation16}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_16 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_16 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_16, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_16,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation17}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 2, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_17 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_17 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_17, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_17,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $5$.
```{r simulation18}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 69, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, ifelse(dt$Y0 > mean0 + 1, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_18 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_18 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_18, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_18,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation19}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0) #Category 1 corresponds to Never-Takers and 2 to Compliers
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  obs_non_compl <- length(which(dt$D != dt$Z))/350
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #Instrumental Variable estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    est_never_taker_freq,
    obs_non_compl <- obs_non_compl,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 10, nrow = nsim))
x <- c("simulation","est_never_taker_freq","obs_non_compl","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_19 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_19 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_19, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_19,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation20}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_20 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_20 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_20, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_20,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation21}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers 
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 14, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
         "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_21 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_21 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_21, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_21,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation22}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_22 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_22 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_22, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_22,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation23}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_noncompliers = 0.4, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_noncompliers * n)), rep(2, n - round(p_noncompliers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- 0
  dt$D1 <- ifelse(dt$Category == 2, 1, 0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "CO"))
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    est_never_taker_freq <- est_never_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 12, nrow = nsim))
x <- c("simulation","true_never_takers","true_compliers","obs_non_compl",
       "est_never_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_23 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_23 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_23, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_23,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation24}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0) #D = ZD(1) + (1-Z)D(0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0) 
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True mean difference among compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 13, nrow = nsim))
x <- c("simulation","obs_non_compl","obs_always_takers","obs_never_takers","est_never_taker_freq","est_always_taker_freq",
       "true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_24 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_24 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP effect:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_24, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV effect:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_24,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$. 
```{r simulation25}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol  estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_25 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_25 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_25, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_25,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation26}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_26 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_26 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_26, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_26,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation27}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_27 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_27 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_27, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_27,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation28}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 2, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_28 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_28 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_28, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_28,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation29}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_29 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_29 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_29, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_29,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation30}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 > mean0 + 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_30 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_30 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_30, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_30,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation31}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_31 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_31 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_31, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_31,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation32}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D0)
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D1)
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, dt$Category)
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_32 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_32 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_32, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_32,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation33}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 2, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_33 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_33 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_33, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_33,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation34}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 2, ifelse(dt$Y0 > mean0 + 1, 1, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_34 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_34 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_34, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_34,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation35}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_35 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_35 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_35, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_35,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Binary Compliance case when the true treatment effect is equal to $0$.
```{r simulation36}
set.seed(24)
simfun <- function(i, n = 350, prob = 0.5, p_nevertakers = 0.25, p_alwaystakers = 0.15, mean0 = 74, mean1 = 74, sd = 1){
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  Category <- c(rep(1, round(p_nevertakers * n)), rep(2, round(p_alwaystakers * n)), 
                rep(3, n - round(p_nevertakers * n) - round(p_alwaystakers * n)))
  dt$Category <- sample(Category, n)
  dt$D0 <- ifelse(dt$Category == 2, 1, 0) 
  dt$D1 <- ifelse(dt$Category == 3 | dt$Category == 2, 1, 0)
  dt$D0 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D0))
  dt$D1 <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D1))
  dt$Category <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 2, dt$Category))
  dt$D <- ifelse(dt$Z == 1, dt$D1, dt$D0)
  dt$Y <- ifelse(dt$D == 1, dt$Y1, dt$Y0)
  dt$Compliance <- factor(dt$Category, labels = c("NT", "AT", "CO"))
  true_always_takers <- nrow(dt %>% filter(Compliance == "AT"))/n #True always takers
  true_never_takers <- nrow(dt %>% filter(Compliance == "NT"))/n #True never takers
  true_compliers <- nrow(dt %>% filter(Compliance == "CO"))/n #True compliers
  obs_non_compl <- length(which(dt$D != dt$Z))/n #Observed non-compliers (observed never-takers and always-takers)
  obs_always_takers <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/n #Observed always takers 
  obs_never_takers <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/n #Observed never takers
  est_never_taker_freq <- nrow(dt %>% filter(Z == 1) %>% filter(D == 0))/nrow(dt %>% filter(Z == 1))
  est_always_taker_freq <- nrow(dt %>% filter(Z == 0) %>% filter(D == 1))/nrow(dt %>% filter(Z == 0))
  compliers <- dt %>% filter(Compliance == "CO") #Defines the subgroup of true compliers 
  treat_prot <- dt %>% filter(Z == 1) %>% filter(D == 1) #Defines the observed compliers in the treatment group
  control_prot <- dt %>% filter(Z == 0) %>% filter(D == 0) #Defines the observed compliers in the control group
  truth <- mean(compliers$Y1) - mean(compliers$Y0) #True treatment effect in compliers
  PPE <- mean(treat_prot$Y) - mean(control_prot$Y) #Per-protocol estimate
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(treat_prot$Y)^2/nrow(treat_prot)) + (sd(control_prot$Y)^2/nrow(control_prot)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  fit_IV <- iv_robust(Y ~ D | Z, data = dt)
  IV <- coef(fit_IV)[2] #IV estimate
  MSE_IV <- mse(truth,IV)
  IV_low <- fit_IV$conf.low[2]
  IV_high <- fit_IV$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  out <- data.frame(
    i = i,
    true_always_takers <- true_always_takers,
    true_never_takers <- true_never_takers,
    true_compliers <- true_compliers,
    obs_non_compl <- obs_non_compl,
    obs_always_takers <- obs_always_takers,
    obs_never_takers <- obs_never_takers,
    est_never_taker_freq <- est_never_taker_freq,
    est_always_taker_freq <- est_always_taker_freq,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 16, nrow = nsim))
x <- c("simulation","true_always_takers","true_never_takers","true_compliers","obs_non_compl","obs_always_takers",
       "obs_never_takers","est_never_taker_freq","est_always_taker_freq","true_effect","PPE","MSE_PPE","PPE_coverage","IV",
       "MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
true_always_takers <- mean(estimates$true_always_takers)
true_never_takers <- mean(estimates$true_never_takers)
true_compliers <- mean(estimates$true_compliers)
obs_always_takers <- mean(estimates$obs_always_takers)
obs_never_takers <- mean(estimates$obs_never_takers)
est_never_taker_freq <- mean(estimates$est_never_taker_freq)
est_always_taker_freq <- mean(estimates$est_always_taker_freq)
observed_non_compliance <- mean(estimates$obs_non_compl)
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_36 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_36 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True never taker frequency:", round(true_never_takers,2), "\n")
cat("True always taker frequency:", round(true_always_takers,2), "\n")
cat("True complier frequency:", round(true_compliers,2), "\n")
cat("Estimated never taker frequency:", round(est_never_taker_freq,2), "\n")
cat("Estimated always taker frequency:", round(est_always_taker_freq,2), "\n")
cat("Observed non-compliance frequency:", round(observed_non_compliance,2), "\n")
cat("Observed never taker frequency:", round(obs_never_takers,2), "\n")
cat("Observed always taker frequency:", round(obs_always_takers,2), "\n")
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_36, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_36,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

For the Partial Compliance we vary the following factors,
\begin{enumerate}
 \item True Treatment Effect,
 \item Type of Non-Compliers,
 \item Randomness of Non-compliers (For the Non-Random case we consider severe and mild Non-Randomness),
 \item Compliance Threshold 
\end{enumerate}

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation37}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_37 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_37 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_37, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_37,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation38}
set.seed(1924)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_38 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_38 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_38, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_38,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation39}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_39 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_39 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_39, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_39,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation40}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_40 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_40 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_40, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_40,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation41}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_41 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_41 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_41, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_41,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation42}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_42 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_42 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_42, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_42,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation43}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_43 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_43 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_43, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_43,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation44}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_44 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_44 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_44, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_44,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation45}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_45 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_45 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_45, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_45,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation46}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_46 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_46 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_46, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_46,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation47}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_47 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_47 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_47, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_47,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation48}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_48 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_48 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_48, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_48,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation49}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_49 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_49 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_49, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_49,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation50}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_50 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_50 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_50, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_50,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation51}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_51 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_51 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_51, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_51,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation52}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_52 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_52 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_52, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_52,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation53}
set.seed(1924)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_53 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_53 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_53, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_53,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation54}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_54 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_54 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_54, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_54,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation55}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_55 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_55 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_55, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_55,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation56}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_56 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_56 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_56, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_56,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation57} 
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_57 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_57 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_57, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_57,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation58}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_58 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_58 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_58, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_58,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation59}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_59 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_59 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_59, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_59,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation60}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_60 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_60 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_60, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_60,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation61}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_61 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_61 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_61, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_61,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation62}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_62 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_62 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_62, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_62,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation63}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_63 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_63 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_63, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_63,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation64}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_64 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_64 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_64, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_64,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation65}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_65 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_65 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_65, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_65,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation66}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_66 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_66 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_66, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_66,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation67}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_67 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_67 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_67, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_67,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation68}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_68 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_68 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_68, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_68,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation69}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_69 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_69 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_69, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_69,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation70}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_70 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_70 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_70, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_70,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation71}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_71 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_71 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_71, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_71,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation72}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_72 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_72 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_72, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_72,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation73}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_73 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_73 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_73, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_73,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation74}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_74 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_74 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_74, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_74,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation75}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_75 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_75 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_75, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_75,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation76}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_76 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_76 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_76, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_76,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation77}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_77 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_77 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_77, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_77,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulations78}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_78 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_78 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_78, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_78,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation79}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_79 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_79 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_79, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_79,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation80}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_80 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_80 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_80, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_80,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation81}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_81 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_81 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_81, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_81,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation82}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_82 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_82 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_82, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_82,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation83}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_83 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_83 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_83, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_83,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation84}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_84 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_84 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_84, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_84,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation85}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_85 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_85 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_85, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_85,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation86}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_86 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_86 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_86, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_86,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation87}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_87 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_87 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_87, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_87,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation88}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_88 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_88 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_88, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_88,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation89}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_89 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_89 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_89, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_89,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation90}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_90 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_90 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_90, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_90,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation91}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_91 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_91 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_91, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_91,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation92}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_92 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_92 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_92, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_92,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation93}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_93 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_93 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_93, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_93,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation94}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_94 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_94 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_94, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_94,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation95}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_95 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_95 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_95, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_95,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation96}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_96 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_96 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_96, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_96,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation97}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_97 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_97 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_97, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_97,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation98}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_98 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_98 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_98, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_98,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation99}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_99 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_99 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_99, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_99,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation100}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_100 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_100 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_100, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_100,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation101}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_101 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_101 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_101, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_101,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation102}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_102 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_102 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_102, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_102,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation103}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_103 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_103 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_103, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_103,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation104}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_104 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_104 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_104, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_104,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation105}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_105 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_105 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_105, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_105,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation106}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_106 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_106 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_106, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_106,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation107}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_107 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_107 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_107, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_107,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation108}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_108 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_108 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_108, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_108,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation109}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_109 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_109 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_109, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_109,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation110}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_110 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_110 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_110, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_110,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation111}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_111 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_111 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_111, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_111,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation112}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_112 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_112 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_112, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_112,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation113}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_113 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_113 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_113, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_113,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation114}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_114 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_114 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_114, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_114,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation115}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_115 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_115 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_115, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_115,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation116}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_116 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_116 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_116, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_116,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation117}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_117 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_117 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_117, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_117,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation118}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_118 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_118 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_118, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_118,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation119}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_119 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_119 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_119, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_119,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation120}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_120 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_120 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_120, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_120,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation121}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_121 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_121 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_121, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_121,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation122}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_122 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_122 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_122, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_122,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation123}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_123 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_123 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_123, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_123,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation124}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_124 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_124 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_124, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_124,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation125}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_125 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_125 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_125, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_125,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation126}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_126 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_126 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_126, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_126,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation127}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_127 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_127 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_127, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_127,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation128}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_128 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_128 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_128, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_128,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation129} 
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_129 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_129 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_129, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_129,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation130}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_130 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_130 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_130, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_130,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation131}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_131 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_131 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_131, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_131,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation132}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_132 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_132 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_132, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_132,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation133}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_133 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_133 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_133, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_133,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation134}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_134 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_134 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_134, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_134,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation135}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_135 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_135 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_135, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_135,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario C for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation136}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario C
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_136 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_136 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_136, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_136,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation137}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_137 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_137 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_137, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_137,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation138}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_138 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_138 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_138, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_138,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation139}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_139 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_139 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_139, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_139,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation140}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_140 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_140 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_140, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_140,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation141}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_141 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_141 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_141, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_141,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation142}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_142 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_142 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_142, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_142,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation143}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_143 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_143 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_143, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_143,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario D for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation144}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario D
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 1, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_144 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_144 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_144, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_144,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation145}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_145 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_145 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_145, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_145,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation146}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_146 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_146 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_146, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_146,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation147}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_147 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_147 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_147, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_147,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation148}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_148 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_148 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_148, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_148,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation149}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_149 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_149 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_149, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_149,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulations150}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_150 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_150 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_150, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_150,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation151}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_151 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_151 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_151, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_151,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario E for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation152}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario E
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse(dt$Y0 > mean0 + 1, 1, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_152 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_152 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_152, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_152,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation153}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_153 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_153 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_153, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_153,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation154}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_154 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_154 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_154, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_154,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation155}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_155 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_155 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_155, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_155,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for severe Non-Randomness ($\delta=0.5$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation156}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_156 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_156 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_156, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_156,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation157}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_157 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_157 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_157, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_157,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation158}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_158 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_158 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_158, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_158,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation159}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_159 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_159 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_159, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_159,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario F for mild Non-Randomness ($\delta=1$) in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation160}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario F
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse(dt$Y0 > mean0 + 1, 0, dt$D))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_160 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_160 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_160, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_160,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation161}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_161 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_161 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_161, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_161,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation162}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_162 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_162 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_162, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_162,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation163}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_163 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_163 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_163, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_163,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Random Non-Compliance case in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation164}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_164 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_164 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_164, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_164,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation165}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_165 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_165 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_165, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_165,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation166}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_166 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_166 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_166, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_166,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation167}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_167 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_167 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_167, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_167,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation168}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_168 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_168 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_168, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_168,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation169}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_169 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_169 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_169, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_169,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation170}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_170 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_170 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_170, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_170,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation171}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_171 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_171 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_171, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_171,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario A for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation172}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_172 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_172 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_172, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_172,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation173}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_173 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_173 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_173, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_173,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation174}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_174 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_174 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_174, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_174,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation175}
set.seed(1924)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_175 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_175 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_175, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_175,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for severe Non-Randomness ($\delta=0.5$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation176}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_176 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_176 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_176, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_176,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation177}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_177 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_177 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_177, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_177,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation178}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_178 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_178 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_178, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_178,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation179}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_179 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_179 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_179, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_179,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario B for mild Non-Randomness ($\delta=1$) in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation180}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario B
  dt$D <- ifelse(dt$Y0 > mean0 + 1, 0, dt$D)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_180 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_180 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_180, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_180,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```


The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation181}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario G
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_181 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_181 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_181, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_181,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation182}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_182 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_182 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_182, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_182,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation183}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_183 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_183 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_183, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_183,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation184}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_184 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_184 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_184, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_184,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation185}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_185 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_185 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_185, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_185,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation186}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_186 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_186 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_186, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_186,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation187}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_187 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_187 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_187, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_187,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation188}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_188 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_188 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_188, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_188,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation189}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_189 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_189 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_189, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_189,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation190}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_190 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_190 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_190, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_190,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation191}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_191 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_191 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_191, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_191,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation192}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_192 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_192 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_192, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_192,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation193}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_193 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_193 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_193, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_193,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation194}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_194 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_194 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_194, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_194,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation195}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_195 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_195 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_195, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_195,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation196}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_196 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_196 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_196, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_196,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation197}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_197 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_197 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_197, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_197,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation198}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_198 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_198 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_198, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_198,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation199}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_199 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_199 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_199, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_199,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation200}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_200 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_200 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_200, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_200,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation201}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_201 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_201 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_201, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_201,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation202}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_202 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_202 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_202, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_202,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation203}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_203 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_203 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_203, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_203,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation204}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_204 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_204 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_204, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_204,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation205}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_205 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_205 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_205, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_205,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation206}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_206 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_206 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_206, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_206,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation207}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_207 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_207 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_207, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_207,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation208}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_208 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_208 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_208, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_208,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $5$.
```{r simulation209}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_209 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_209 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_209, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_209,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $5$.
```{r simulation210}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_210 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_210 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_210, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_210,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $5$.
```{r simulation211}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_211 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_211 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_211, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_211,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $5$.
```{r simulation212}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 69, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_212 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_212 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_212, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_212,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation213}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario G
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_213 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_213 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_213, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_213,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation214}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_214 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_214 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_214, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_214,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation215}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_215 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_215 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_215, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_215,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation216}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 0, ifelse((mean0 < dt$Y0 & dt$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < dt$Y0 & dt$Y0 < mean0 + 0.3, 1/2,
                      ifelse((mean0 + 0.3 < dt$Y0 & dt$Y0 < mean0 + 0.5), 3/4, ifelse(dt$Y0 > mean0 + 0.5, 1, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_216 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_216 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_216, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_216,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation217}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_217 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_217 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_217, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_217,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation218}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_218 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_218 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_218, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_218,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation219}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_219 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_219 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_219, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_219,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation220}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < dt$Y0 & dt$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < dt$Y0 & dt$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < dt$Y0 & dt$Y0 < mean0 + 1), 3/4, ifelse(dt$Y0 > mean0 + 1, 1, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_220 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_220 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_220, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_220,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation221}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_221 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_221 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_221, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_221,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation222}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_222 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_222 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_222, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_222,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation223}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_223 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_223 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_223, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_223,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation224}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < dt$Y0 & dt$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < dt$Y0 & dt$Y0 < mean0 - 0.15, 1/2,
                                                 ifelse((mean0 - 0.15 < dt$Y0 & dt$Y0 < mean0), 1/4, ifelse(dt$Y0 > mean0 + 0.5, 0, dt$D)))))
  
  
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_224 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_224 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_224, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_224,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation225}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_225 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_225 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_225, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_225,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation226}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_226 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_226 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_226, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_226,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation227}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_227 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_227 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_227, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_227,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of both Never-Takers and Always-Takers for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation228}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  D_values_control <- c(0, 1/4, 1/2, 3/4, 1)
  D_probabilities_control <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  control$D <- sample(D_values_control, nrow(control), replace = TRUE, prob = D_probabilities_control)
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  dt <- bind_rows(control, treatment)
  #Impose the condition of Scenario A
  dt$D <- ifelse(dt$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < dt$Y0 & dt$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < dt$Y0 & dt$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < dt$Y0 & dt$Y0 < mean0 - 0.5), 1/4, ifelse(dt$Y0 > mean0 + 1, 0, dt$D)))))
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_228 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_228 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_228, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_228,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation229}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_229 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_229 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_229, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_229,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation230}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_230 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_230 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_230, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_230,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation231}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_231 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_231 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_231, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_231,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation232}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 0, ifelse((mean0 < treatment$Y0 & treatment$Y0 < mean0 + 0.15), 1/4, ifelse(mean0 + 0.15 < treatment$Y0 & treatment$Y0 < mean0 + 0.3, 1/2, ifelse((mean0 + 0.3 < treatment$Y0 & treatment$Y0 < mean0 + 0.5), 3/4, ifelse(treatment$Y0 > mean0 + 0.5, 1, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_232 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_232 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_232, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_232,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation233}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_233 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_233 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_233, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_233,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation234}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  #We consider compliers in the treatment group as participants who took at least half of the treatment, i.e. at least 4hours of CPAP
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_234 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_234 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_234, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_234,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation235}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_235 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_235 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_235, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_235,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario G for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation236}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 0, ifelse((mean0 + 0.5 < treatment$Y0 & treatment$Y0 < mean0 + 0.65), 1/4, ifelse(mean0 + 0.65 < treatment$Y0 & treatment$Y0 < mean0 + 0.8, 1/2, ifelse((mean0 + 0.8 < treatment$Y0 & treatment$Y0 < mean0 + 1), 3/4, ifelse(treatment$Y0 > mean0 + 1, 1, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_236 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_236 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_236, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_236,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation237}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_237 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_237 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_237, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_237,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation238}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_238 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_238 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_238, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_238,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation239}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_239 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_239 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_239, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_239,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for severe Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation240}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 0.5, 1, ifelse((mean0 - 0.5 < treatment$Y0 & treatment$Y0 < mean0 - 0.3), 3/4, ifelse(mean0 - 0.3 < treatment$Y0 & treatment$Y0 < mean0 - 0.15, 1/2, ifelse((mean0 - 0.15 < treatment$Y0 & treatment$Y0 < mean0), 1/4, ifelse(treatment$Y0 > mean0 + 0.5, 0, treatment$D)))))
  
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_240 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_240 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_240, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_240,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case I for the Threshold when the true treatment effect is equal to $0$.
```{r simulation241}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D == 1) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_241 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_241 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_241, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_241,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case II for the Threshold when the true treatment effect is equal to $0$.
```{r simulation242}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_242 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_242 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_242, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_242,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case III for the Threshold when the true treatment effect is equal to $0$.
```{r simulation243}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D %in% c(1/2,3/4,1)) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_243 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_243 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_243, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_243,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following code chunk implements the Non-Random Non-Compliance Scenario H for mild Non-Randomness in the presence of Never-Takers only for the Partial Compliance case and Case IV for the Threshold when the true treatment effect is equal to $0$.
```{r simulation244}
set.seed(24)
simfun <- function(i, n=350, mean0 = 74, mean1 = 74, sd = 1, prob = 0.5){
  #Data Generating Mechanism (DGM)
  dt <- data.frame(
    ID = 1:n,
    Y0 = rnorm(n, mean = mean0, sd = sd), 
    Y1 = rnorm(n, mean = mean1, sd = sd),
    Z = rbinom(n = n, size = 1, prob = prob))
  
  control <- dt %>% filter(Z == 0)
  treatment <- dt %>% filter(Z == 1)
  
  #Random allocation of D and calculation of Y
  control$D <- 0
  D_values_treatment <- c(1, 3/4, 1/2, 1/4, 0)
  D_probabilities_treatment <- c(0.5, 0.2, 0.1, 0.1, 0.1)
  treatment$D <- sample(D_values_treatment, nrow(treatment), replace = TRUE, prob = D_probabilities_treatment)
  treatment$D <- ifelse(treatment$Y0 < mean0 - 1, 1, ifelse((mean0 - 1 < treatment$Y0 & treatment$Y0 < mean0 - 0.8), 3/4, ifelse(mean0 - 0.8 < treatment$Y0 & treatment$Y0 < mean0 - 0.65, 1/2, ifelse((mean0 - 0.65 < treatment$Y0 & treatment$Y0 < mean0 - 0.5), 1/4, ifelse(treatment$Y0 > mean0 + 1, 0, treatment$D)))))
  dt <- bind_rows(control, treatment)
  dt$Y <- (dt$D)*(dt$Y1) + (1-dt$D)*(dt$Y0)
  
  #Defining the threshold and calculating the estimates
  true_compl_trt <- dt %>% filter(Z == 1) %>% filter(D != 0) 
  true_compl_ctr <- dt %>% filter(Z == 0) %>% filter(D == 0) 
  true_compliers <- rbind(true_compl_trt,true_compl_ctr)
  truth <- mean(true_compliers$Y1) - mean(true_compliers$Y0)
  PPE <- mean(true_compl_trt$Y) - mean(true_compl_ctr$Y)
  MSE_PPE <- mse(truth,PPE)
  PPE_SE <- sqrt((sd(true_compl_trt$Y)^2/nrow(true_compl_trt)) + (sd(true_compl_ctr$Y)^2/nrow(true_compl_ctr)))
  PPE_low <- PPE - qnorm(0.975)*PPE_SE
  PPE_high <- PPE + qnorm(0.975)*PPE_SE
  PPE_coverage <- PPE_low <= truth & truth <= PPE_high
  IV_fit <- iv_robust(Y ~ D | Z, data=dt)
  IV <- coef(IV_fit)[2]
  MSE_IV <- mse(truth,IV)
  IV_low <- IV_fit$conf.low[2]
  IV_high <- IV_fit$conf.high[2]
  IV_coverage <- IV_low <= truth & truth <= IV_high
  
  out <- data.frame(
    i = i,
    truth <- truth,
    PPE <- PPE,
    MSE_PPE <- MSE_PPE,
    PPE_coverage <- PPE_coverage,
    IV <- IV,
    MSE_IV <- MSE_IV,
    IV_coverage <- IV_coverage
  )
  return(out)
  
}


nsim <- 500
estimates <- data.frame(matrix(ncol = 8, nrow = nsim))
x <- c("simulation","true_effect","PPE","MSE_PPE","PPE_coverage","IV","MSE_IV","IV_coverage")
colnames(estimates) <- x
for (r in 1:nsim) {
  estimates[r,] <- simfun(i = r)
  
}
truth <- mean(estimates$true_effect)  
PPE <- mean(estimates$PPE) 
PPE_bias_244 <- round(truth,2) - round(PPE,2)
MSE_PPE <- mean(estimates$MSE_PPE)
PPE_coverage <- mean(estimates$PPE_coverage)
IV <- mean(estimates$IV) 
IV_bias_244 <- round(truth,2) - round(IV,2)
MSE_IV <- mean(estimates$MSE_IV)
IV_coverage <- mean(estimates$IV_coverage)
cat("True effect:", round(truth, 2), "\n")
cat("PP estimate:", round(PPE, 2), "\n")
cat("PP bias:", PPE_bias_244, "\n")
cat("MSE PPE:", round(MSE_PPE,3), "\n")
cat("PPE Coverage:", PPE_coverage, "\n")
cat("IV estimate:", round(IV, 2), "\n")
cat("IV bias:", IV_bias_244,"\n")
cat("MSE IV:", round(MSE_IV,3),"\n")
cat("IV Coverage:", IV_coverage, "\n")
```

The following figure illustrates the bias of the Per-Protocol and the IV estimators when Compliance is Binary, the true treatment effect is $5$ and for the Non-Random Scenarios we only consider the severe case.
```{r}
PPE_bias <- numeric(244)
IV_bias <- numeric(244)
for (i in 1:244) {
  PPE_bias[i] <- get(paste0("PPE_bias_", i))
  IV_bias[i] <- get(paste0("IV_bias_", i))
}
data <- data.frame(
  Simulation = 1:244,
  PPE_Bias = PPE_bias,
  IV_Bias = IV_bias
)
simulations_to_plot <- c(1, 2, 4, 6, 7, 9, 11, 13, 15, 17)
filtered_data <- data[data$Simulation %in% simulations_to_plot, ]
melted_data <- melt(filtered_data, id.vars = "Simulation", variable.name = "Estimator", value.name = "Bias")
ggplot(melted_data, aes(x = Simulation, y = Bias, color = Estimator, shape = Estimator)) +
  geom_point(position = position_jitter(width = 0.2, height = 0)) +
  geom_text(aes(label = Simulation), position = position_jitter(width = 0.2, height = 0), vjust = -1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Bias of Per-Protocol and IV Estimators when the treatment effect is 5",
       x = "Simulation",
       y = "Bias") +
  theme_minimal() +
  scale_shape_manual(values = c(16, 17))
```

The following figure illustrates the bias of the Per-Protocol and the IV estimators when Compliance is Partial, the true treatment effect is $5$ and for the Non-Random Scenarios (A-F) we only consider the severe case.
```{r}
simulations_to_plot_2 <- c(37,38,39,40,41,42,43,44,49,50,51,52,57,58,59,60,65,66,67,68,73,74,75,76,81,82,83,84,89,90,91,92,93,94,95,96,
                           101,102,103,104)
filtered_data_2 <- data[data$Simulation %in% simulations_to_plot_2, ]
melted_data_2 <- melt(filtered_data_2, id.vars = "Simulation", variable.name = "Estimator", value.name = "Bias")
ggplot(melted_data_2, aes(x = Simulation, y = Bias, color = Estimator, shape = Estimator)) +
  geom_point(position = position_jitter(width = 0.2, height = 0)) +
  geom_text(aes(label = Simulation), position = position_jitter(width = 0.2, height = 0), vjust = -1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Bias of Per-Protocol and IV Estimators",
       x = "Simulation",
       y = "Bias") +
  theme_minimal() +
  scale_shape_manual(values = c(16, 17))
```

The following figure illustrates the bias of the Per-Protocol and the IV estimators when Compliance is Partial, the true treatment effect is $5$ for Scenarios G and H for the severe case.
```{r}
simulations_to_plot_3 <- c(181,182,183,184,189,190,191,192,197,198,199,200,205,206,207,208)
filtered_data_3 <- data[data$Simulation %in% simulations_to_plot_3, ]
melted_data_3 <- melt(filtered_data_3, id.vars = "Simulation", variable.name = "Estimator", value.name = "Bias")
ggplot(melted_data_3, aes(x = Simulation, y = Bias, color = Estimator, shape = Estimator)) +
  geom_point(position = position_jitter(width = 0.2, height = 0)) +
  geom_text(aes(label = Simulation), position = position_jitter(width = 0.2, height = 0), vjust = -1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Bias of Per-Protocol and IV Estimators",
       x = "Simulation",
       y = "Bias") +
  theme_minimal() +
  scale_shape_manual(values = c(16, 17))
```